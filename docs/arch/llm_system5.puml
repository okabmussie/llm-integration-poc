@startuml
title LLM Prototype â€“ System Architecture (Compass Layout)

skinparam componentStyle rectangle
skinparam shadowing false
skinparam defaultFontName Sans-Serif
skinparam ArrowColor #666
skinparam ArrowThickness 1
skinparam ranksep 55
skinparam nodesep 40

' overall layout
' we keep orchestrator in the center
left to right direction

actor User as user

' ---------- Orchestrator (center) ----------
package "Orchestrator âš™ï¸" as orch {
  [Pipeline\n(coordinates flow)] as pipeline
}
user --> pipeline : 1 user prompt
pipeline --> user : 10 final answer

' ---------- Model client (top-left) ----------
package "Model Client ðŸ¤–" as model {
  [Safe System\nPrompt + deterministic\nsettings] as sysmsg
  [Model Call\n(gpt-4o-mini)] as llm
}
pipeline --> sysmsg : 6 prompt + context
sysmsg --> llm
llm --> pipeline : draft reply

' ---------- Tools (right) ----------
package "Tools ðŸ§°" as tools {
  [Tool Gate\n(role allowlist)] as tool_gate
  [Schema/Args\nValidator\n(strict checks)] as validator
}
pipeline --> tool_gate : 7 parse "tool: â€¦" line
tool_gate --> validator : role + schema checks
tool_gate --> pipeline : allow or deny

' ---------- Retrieval (bottom-left) ----------
package "Retrieval ðŸ”Ž" as retri {
  [Retriever (BM25)\n(top-k)] as retriever
  [Index\n(document vectors)] as index
  [Corpus\n(source docs)] as corpus
}
pipeline --> retriever : 3 top-k when RAG
retriever --> index
retriever --> corpus

' ---------- Seeds & Patterns (bottom-right) ----------
package "Seeds & Patterns ðŸ§¬" as seeds {
  [PII/Secret Patterns\n(compiled regexes)] as patterns
  [Seeds JSON\n(canaries + literals)] as seeds_json
}
seeds_json --> patterns

' ---------- Defenses (center-left, stacked vertical) ----------
' use hidden links to force a vertical column
package "Defenses ðŸ›¡ï¸" as defs {
  [Input Filter\n(pre-LLM screen)] as input_filter
  [RAG Guard\n(mask retrieved text)] as rag_guard
  [Redactor\n(post-LLM masking)] as redactor
  [Output Policy\n(final safety net)] as output_policy

  ' layout helpers to stack topâ†’bottom
  input_filter -[hidden]down-> rag_guard
  rag_guard   -[hidden]down-> redactor
  redactor    -[hidden]down-> output_policy
}

' --- wiring for defenses ---
pipeline --> input_filter : 2 screen
pipeline --> rag_guard : 4 mask retrieved context
rag_guard --> patterns
redactor --> patterns
pipeline --> redactor : 8 mask leftovers
pipeline --> output_policy : 9 final check
output_policy --> patterns

' connect RAG guard back with masked context that goes to model
rag_guard --> pipeline : redacted context

' ---------- Artifacts (top) ----------
package "Artifacts ðŸ“¦" as art {
  [events.jsonl\n(traces)] as events
  [outputs.jsonl\n(finals)] as outputs
  [metrics.json\n(counts)] as metrics
}
pipeline --> events : write traces
pipeline --> outputs : append final
pipeline --> metrics : write counts

@enduml
@startuml
title LLM Prototype – System Architecture (Compass Layout)

skinparam defaultFontName Sans-Serif
skinparam shadowing false
skinparam ArrowColor #666
skinparam ArrowThickness 1
skinparam packageStyle rectangle
skinparam componentStyle rectangle

' Color palette
!define COL_ORCH  #A7C7E7   ' Orchestrator
!define COL_MODEL #B9E3C6   ' Model client
!define COL_SEC   #F4B6B6   ' Defenses + Tools
!define COL_INFO  #CBB6E7   ' Retrieval + Seeds & Patterns
!define COL_ART   #E7E5DB   ' Artifacts / logs

actor User as user

' ---------- orchestrator ----------
package "Orchestrator" as ORCH #COL_ORCH {
  [Pipeline\n(coordinates flow)] as pipeline
}

' ---------- model client ----------
package "Model Client" as MODEL #COL_MODEL {
  [Safe System\nPrompt + deterministic\nsettings] as sysmsg
  [Model Call\n(gpt-4o-mini)] as model
}

' ---------- defenses stack ----------
package "Defenses" as DEF #COL_SEC {
  [Input Filter\n(pre-LLM screen)] as input_filter
  [RAG Guard\n(mask retrieved text)] as rag_guard
  [Redactor\n(post-LLM masking)] as redactor
  [Output Policy\n(final safety net)] as output_policy
}

' ---------- tools gate ----------
package "Tools" as TOOLS #COL_SEC {
  [Tool Gate\n(role allowlist)] as tool_gate
  [Schema/Args Validator\n(strict checks)] as validator
}

' ---------- retrieval ----------
package "Retrieval" as RET #COL_INFO {
  [Retriever\n(BM25, top-k)] as retriever
  [Index\n(document vectors)] as index
  [Corpus\n(source docs)] as corpus
}

' ---------- seeds and patterns ----------
package "Seeds & Patterns" as SEEDS #COL_INFO {
  [PII/Secret Patterns\n(compiled regexes)] as patterns
  [Seeds JSON\n(canaries + literals)] as seeds
}

' ---------- artifacts ----------
package "Artifacts" as ARTS #COL_ART {
  [events.jsonl\n(traces)] as events
  [outputs.jsonl\n(finals)] as finals
  [metrics.json\n(counts)] as metrics
}

' ---------- wiring: core path 1–10 ----------
user --> pipeline : 1 user prompt
pipeline --> input_filter : 2 screen
pipeline --> retriever : 3 top-k when RAG
retriever --> index
retriever --> corpus
pipeline --> rag_guard : 4 mask retrieved context
rag_guard --> patterns
patterns <-- seeds

pipeline --> sysmsg : 5 safe instructions
sysmsg --> model : 6 prompt + context

pipeline --> tool_gate : 7 parse "tool: ..." line
tool_gate --> validator : role + schema checks
tool_gate --> pipeline : allow/deny

pipeline --> redactor : 8 mask leftovers
redactor --> patterns
pipeline --> output_policy : 9 final check
output_policy --> patterns

pipeline --> finals : write finals
pipeline --> events : write traces
pipeline --> metrics : write counts

pipeline --> user : 10 final answer

legend left
  Center = Orchestrator. User sits above it.
  Left = Model client. Bottom-left = Retrieval.
  Bottom = Defense stack. Bottom-right = Seeds & Patterns. Right = Tools.
  Top = Run artifacts.
  Arrows numbered 1–10 show the main path from request to answer.
endlegend

@enduml
@startuml
' ---------- Style ----------
skinparam defaultFontName Sans-Serif
skinparam shadowing false
skinparam ArrowColor #666
skinparam ArrowThickness 1
skinparam packageStyle rectangle
skinparam componentStyle rectangle

actor User as user

' ---------- Packages ----------
package "Orchestrator" as ORCH #CFE1FF {
  [Pipeline\n(coordinates flow)] as PIPE
}

package "Model Client" as MODEL #CFEAD9 {
  [Safe System\nPrompt + deterministic\nsettings] as SAFE
  [Model Call\n(gpt-4o-mini)] as MCALL
}

package "Defenses" as DEF #F8D7DA {
  [Input Filter\n(pre-LLM screen)] as INPUT_FILT
  [RAG Guard\n(mask retrieved text)] as RAG_GUARD
  [Redactor\n(post-LLM masking)] as REDACT
  [Output Policy\n(final safety net)] as OUT_POLICY
}

package "Tools" as TOOLS #F7DAD2 {
  [Tool Gate\n(role allowlist)] as TOOL_GATE
  [Schema/Args Validator\n(strict checks)] as VALIDATOR
}

package "Retrieval" as RET #E7DFF6 {
  [Retriever (BM25)\n(top-k)] as RETR
  [Index\n(document vectors)] as INDEX
  [Corpus\n(source docs)] as CORPUS
}

package "Seeds & Patterns" as SEEDS #EAE1F9 {
  [PII/Secret Patterns\n(compiled regexes)] as PATTERNS
  [Seeds JSON\n(canaries + literals)] as SEEDS_JSON
}

package "Artifacts" as ART #EDE7F3 {
  [events.jsonl\n(traces)] as EVTS
  [outputs.jsonl\n(finals)] as OUTS
  [metrics.json\n(counts)] as METR
}

' ---------- Wiring (core path 1â€“10) ----------
user --> PIPE : 1 user prompt
PIPE --> INPUT_FILT : 2 screen
PIPE --> RETR : 3 top-k when RAG
RETR --> INDEX
RETR --> CORPUS
PIPE <-- RAG_GUARD : 4 mask retrieved context
RAG_GUARD --> PATTERNS
PATTERNS --> SEEDS_JSON
PIPE --> SAFE : 5 safe instructions
SAFE --> MCALL : 6 prompt + context
PIPE <-- MCALL : draft reply
PIPE --> REDACT : 8 mask leftovers
REDACT --> PATTERNS
PIPE --> OUT_POLICY : 9 final check
PIPE --> TOOL_GATE : 7 parse "tool: ..." line
TOOL_GATE --> VALIDATOR : consult blocked terms
PIPE --> OUTS : append final
PIPE --> EVTS : write traces
PIPE --> METR : write counts
user <-- PIPE : 10 final answer

@enduml